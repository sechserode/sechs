<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sechs.in | Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCt3X1Bny5WoChcOJF3u6HHMno8Q1NRkGA",
            authDomain: "sechserodein.firebaseapp.com",
            projectId: "sechserodein",
            storageBucket: "sechserodein.firebasestorage.app",
            messagingSenderId: "512860067969",
            appId: "1:512860067969:web:7598185d34697d75b89580",
            measurementId: "G-1RDBVH8WS1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use a fixed App ID for your production database path
        const appId = 'sechserodein';
        
        // State
        let editingId = null;
        let itemToDeleteId = null;
        let adminProducts = [];

        async function initApp() {
            try {
                // FIXED: Directly use anonymous auth for your custom project.
                // Ensure 'Anonymous' is enabled in Firebase Console > Authentication.
                await signInAnonymously(auth);
                
                // Start listening for data immediately after init
                loadAdminProducts();

            } catch (error) {
                console.error("Auth error:", error);
                if (error.code === 'auth/operation-not-allowed') {
                    showStatus("Error: Enable 'Anonymous' Auth in Firebase Console", true);
                } else if (error.code === 'auth/configuration-not-found') {
                    showStatus("Error: Firebase Auth not enabled or Invalid API Key", true);
                }
            }
        }

        // Real-time listener for the product list (Grouped by Category)
        function loadAdminProducts() {
            const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            const q = query(productsRef);
            
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('productList');
                listContainer.innerHTML = '';
                adminProducts = [];

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No products found.</p>';
                    return;
                }

                // Group data objects
                const groups = {
                    'wallpaper': [],
                    'pvc': [],
                    'plants': [],
                    'install': [],
                    'other': []
                };

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const item = { id, ...data };
                    adminProducts.push(item);

                    if (groups[data.category]) {
                        groups[data.category].push(item);
                    } else {
                        groups['other'].push(item);
                    }
                });

                // Helper to render a group section
                const renderGroup = (title, items) => {
                    if (!items || items.length === 0) return;

                    const groupHeader = document.createElement('h3');
                    groupHeader.className = "text-xs font-bold text-gray-500 uppercase tracking-widest mt-6 mb-3 border-b border-gray-100 pb-2 flex items-center gap-2";
                    groupHeader.innerHTML = `<i class="fa-solid fa-layer-group"></i> ${title} <span class="ml-auto bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px]">${items.length}</span>`;
                    listContainer.appendChild(groupHeader);

                    items.forEach(data => {
                        // Logic for displaying price in list
                        const hasDiscount = data.discountPrice && Number(data.discountPrice) > 0;
                        const priceDisplay = hasDiscount 
                            ? `<span class="text-red-600 font-bold">₹${data.discountPrice}</span> <span class="text-gray-400 line-through text-[10px]">₹${data.price}</span>` 
                            : `₹${data.price}`;

                        const item = document.createElement('div');
                        item.className = "flex items-center justify-between p-4 bg-white rounded-lg border border-gray-100 hover:border-nature/30 hover:shadow-sm transition mb-2 group";
                        item.innerHTML = `
                            <div class="flex items-center gap-4 overflow-hidden">
                                <img src="${data.image}" class="w-12 h-12 object-cover rounded-md bg-gray-50 shrink-0 border border-gray-100" onerror="this.src='https://via.placeholder.com/50'">
                                <div class="min-w-0">
                                    <h4 class="font-bold text-gray-800 truncate text-sm">${data.title}</h4>
                                    <p class="text-xs text-gray-500 truncate mt-0.5">${priceDisplay} / ${data.unit}</p>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0 ml-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                <button onclick="handleEdit('${data.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition flex items-center justify-center border border-blue-100" title="Edit">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button onclick="handleDelete('${data.id}')" class="w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center border border-red-100" title="Delete">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                };

                // Render groups in specific order
                renderGroup('Wallpapers', groups['wallpaper']);
                renderGroup('PVC Panels', groups['pvc']);
                renderGroup('Artificial Plants', groups['plants']);
                renderGroup('Previous Works', groups['install']);
                renderGroup('Uncategorized', groups['other']);

            }, (error) => {
                console.error("Error loading products:", error);
                const listContainer = document.getElementById('productList');
                if (error.code === 'permission-denied') {
                     listContainer.innerHTML = '<p class="text-red-500 text-center py-4">Permission Denied. Check Firestore Rules.</p>';
                } else {
                     listContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading products.</p>';
                }
            });
        }

        // Handle Form Submission (Add OR Update)
        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            const formData = {
                title: document.getElementById('p_title').value,
                image: document.getElementById('p_image').value,
                category: document.getElementById('p_category').value,
                price: document.getElementById('p_price').value,
                discountPrice: document.getElementById('p_discount').value, // NEW Field
                unit: document.getElementById('p_unit').value,
                desc: document.getElementById('p_desc').value,
                updatedAt: new Date().toISOString()
            };

            // If creating new, add createdAt
            if (!editingId) {
                formData.createdAt = new Date().toISOString();
            }

            try {
                const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                
                if (editingId) {
                    // Update existing
                    await updateDoc(doc(productsRef, editingId), formData);
                    showStatus('Product updated successfully!');
                } else {
                    // Add new
                    await addDoc(productsRef, formData);
                    showStatus('Product added successfully!');
                }
                
                resetForm();

            } catch (err) {
                console.error("Error saving product:", err);
                showStatus('Error: ' + err.message, true);
            } finally {
                btn.innerHTML = editingId ? '<i class="fa-solid fa-save mr-2"></i> Update Product' : '<i class="fa-solid fa-plus mr-2"></i> Add to Collection';
                if (!editingId) btn.innerHTML = originalText; // Revert to original if adding
                btn.disabled = false;
            }
        }

        // Edit Handler
        window.handleEdit = function(id) {
            const product = adminProducts.find(p => p.id === id);
            if (!product) return;

            editingId = id;
            
            // Populate form
            document.getElementById('p_title').value = product.title || '';
            document.getElementById('p_image').value = product.image || '';
            document.getElementById('p_category').value = product.category || 'wallpaper';
            document.getElementById('p_price').value = product.price || '';
            document.getElementById('p_discount').value = product.discountPrice || ''; // NEW Field
            document.getElementById('p_unit').value = product.unit || '';
            document.getElementById('p_desc').value = product.desc || '';

            // Update UI state
            document.getElementById('formTitle').innerText = 'Edit Product';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-save mr-2"></i> Update Product';
            document.getElementById('submitBtn').classList.remove('bg-nature');
            document.getElementById('submitBtn').classList.add('bg-blue-600');
            document.getElementById('cancelBtn').classList.remove('hidden');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Modal Delete Logic
        window.handleDelete = function(id) {
            itemToDeleteId = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeDeleteModal = function() {
            itemToDeleteId = null;
            const modal = document.getElementById('deleteModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.confirmDelete = async function() {
            if (!itemToDeleteId) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', itemToDeleteId);
                await deleteDoc(docRef);
                closeDeleteModal();
                showStatus('Item deleted successfully.');
            } catch (err) {
                console.error("Error deleting:", err);
                closeDeleteModal();
                showStatus('Failed to delete item.', true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Reset Handler
        window.resetForm = function() {
            document.querySelector('form').reset();
            editingId = null;
            
            // Reset UI
            document.getElementById('formTitle').innerText = 'Add New Product';
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Add to Collection';
            submitBtn.classList.add('bg-nature');
            submitBtn.classList.remove('bg-blue-600');
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        function showStatus(msg, isError = false) {
            const el = document.getElementById('adminSuccess');
            const icon = isError ? '<i class="fa-solid fa-circle-exclamation mr-2"></i>' : '<i class="fa-solid fa-check-circle mr-2"></i>';
            
            // Remove old colors
            el.classList.remove('text-green-600', 'text-red-600');
            
            // Add new color
            el.classList.add(isError ? 'text-red-600' : 'text-green-600');
            
            el.innerHTML = `${icon} ${msg}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        
        initApp();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap');
        
        :root {
            --primary: #2d5a27; 
            --secondary: #f4f1ea; 
            --accent: #d4af37; 
        }

        body { font-family: 'Inter', sans-serif; }
        .bg-nature { background-color: var(--primary); }
        .text-nature { color: var(--primary); }
        .text-accent { color: var(--accent); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto px-4 py-12">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <span class="text-nature">SECHS</span> ADMIN
            </h1>
            <!-- Explicit relative path -->
            <a href="./index.html" class="text-nature hover:underline flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> Back to Website
            </a>
        </div>

        <!-- Add/Edit Form -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                <i class="fa-solid fa-pen-to-square text-accent text-2xl"></i>
                <div>
                    <h2 id="formTitle" class="text-2xl font-bold text-gray-800">Add New Product</h2>
                    <p class="text-sm text-gray-500">Details update immediately on the main website.</p>
                </div>
            </div>

            <form onsubmit="handleFormSubmit(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Col -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Product Title</label>
                            <input type="text" id="p_title" required placeholder="e.g. Royal Gold Wallpaper" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition">
                        </div>
                        
                        <!-- Price and Discount Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Original Price (₹)</label>
                                <input type="number" id="p_price" required placeholder="120" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Discount Price (₹)</label>
                                <input type="number" id="p_discount" placeholder="100" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition">
                                <p class="text-[10px] text-gray-500 mt-1">Leave empty if no discount.</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Unit</label>
                            <input type="text" id="p_unit" required placeholder="sq.ft / piece" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition">
                        </div>
                        
                         <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Category</label>
                            <select id="p_category" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition bg-white">
                                <option value="wallpaper">Wallpaper</option>
                                <option value="plants">Artificial Plants</option>
                                <option value="install">Previous Works</option>
                                <option value="pvc">PVC Panels</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right Col -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Image URL</label>
                            <input type="url" id="p_image" required placeholder="https://..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition">
                            <p class="text-xs text-gray-500 mt-1">Paste a link to your image (e.g. from Unsplash or your image host).</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                            <textarea id="p_desc" rows="4" required placeholder="Brief description of the product or project..." class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-nature transition"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-50 mt-4">
                    <div id="adminSuccess" class="hidden text-green-600 font-semibold animate-pulse">
                        <i class="fa-solid fa-check-circle mr-2"></i> Success!
                    </div>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" id="cancelBtn" onclick="resetForm()" class="hidden px-6 py-3 rounded-lg font-bold text-gray-600 hover:bg-gray-100 transition">
                            Cancel
                        </button>
                        <button type="submit" id="submitBtn" class="bg-nature text-white px-8 py-3 rounded-lg font-bold hover:opacity-90 transition shadow-md">
                            <i class="fa-solid fa-plus mr-2"></i> Add to Collection
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Inventory List -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                <i class="fa-solid fa-boxes-stacked text-gray-400 text-2xl"></i>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Manage Inventory</h2>
                    <p class="text-sm text-gray-500">Edit or remove existing items.</p>
                </div>
            </div>
            
            <div id="productList" class="space-y-1 max-h-[800px] overflow-y-auto pr-2 custom-scrollbar bg-gray-50/50 p-4 rounded-xl border border-gray-100">
                <!-- Items loaded by JS -->
                <div class="text-center py-8 text-gray-400">
                    <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
                    <p class="mt-2">Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Confirm Delete</h3>
                <p class="text-gray-500 text-sm mt-2">Are you sure you want to remove this item? This action cannot be undone.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-semibold transition">Cancel</button>
                <button id="confirmDeleteBtn" onclick="confirmDelete()" class="flex-1 px-4 py-2.5 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold shadow-lg shadow-red-200 transition">Delete</button>
            </div>
        </div>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }
    </style>
</body>
</html>
